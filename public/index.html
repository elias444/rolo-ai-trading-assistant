<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rolo AI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="application-name" content="Rolo AI">
    <title>Rolo AI Trading Assistant</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000000; /* Dark background */
            color: #ffffff; /* White text */
            margin: 0;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; /* Respect safe areas on iOS */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Prevent scrolling on main body */
        }

        .header {
            background-color: #1c1c1e; /* Darker grey for header */
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            border-bottom: 0.5px solid #38383a; /* Subtle separator */
            z-index: 10;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto; /* Scrollable content area */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            padding: 15px;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            background-color: #1c1c1e; /* Darker grey for tab bar */
            border-top: 0.5px solid #38383a; /* Subtle separator */
            padding-bottom: env(safe-area-inset-bottom); /* Respect safe areas on iOS */
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 10;
        }

        .tab-button {
            flex: 1;
            padding: 12px 0;
            background: none;
            border: none;
            color: #8e8e93; /* Grey for inactive tabs */
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tab-button.active {
            color: #0a84ff; /* iOS Blue for active tab */
        }

        .tab-button i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
            padding: 10px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Basic Card Style for content sections */
        .card {
            background-color: #2c2c2e; /* Slightly lighter grey for cards */
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        input[type="text"], textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #3a3a3c;
            background-color: #48484a; /* Input background */
            color: #ffffff;
            font-size: 16px;
        }

        button {
            background-color: #0a84ff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        button:active {
            background-color: #30a4ff; /* Slightly lighter blue on tap */
        }

        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 15px;
        }

        .chat-message.user {
            background-color: #0a84ff; /* iOS blue for user */
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.assistant {
            background-color: #3a3a3c; /* Dark grey for assistant */
            align-self: flex-start;
            margin-right: auto;
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px); /* Adjust based on header/footer */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            border-radius: 10px;
            background-color: #1c1c1e;
        }
    </style>
</head>
<body>
    <div class="header">Rolo AI</div>

    <div class="content">
        <div id="chatTab" class="tab-content active">
            <div class="card">
                <h2>AI Assistant</h2>
                <div id="chatWindow" class="chat-window">
                    <div class="chat-message assistant">Hello! I'm Rolo, your AI-powered trading assistant. How can I help you today?</div>
                </div>
                <input type="text" id="chatInput" placeholder="Ask Rolo something...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div id="tickerTab" class="tab-content">
            <div class="card">
                <h2>Stock Ticker</h2>
                <input type="text" id="tickerInput" placeholder="Enter stock symbol (e.g., AAPL)">
                <button onclick="searchStock()">Search</button>
                <div id="tickerOutput" style="margin-top: 15px;">
                    <p>Search for a stock to see its real-time data.</p>
                </div>
                <h3>My Favorites</h3>
                <ul id="favoritesList" style="list-style: none; padding: 0;">
                    <li>No favorites added yet.</li>
                </ul>
            </div>
        </div>

        <div id="analysisTab" class="tab-content">
            <div class="card">
                <h2>Analysis</h2>
                <p>Detailed technical and sentiment analysis will appear here.</p>
                <div id="analysisOutput" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="playsTab" class="tab-content">
            <div class="card">
                <h2>Smart Plays</h2>
                <p>AI-generated trading opportunities will be displayed here.</p>
                <div id="playsOutput" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="marketTab" class="tab-content">
            <div class="card">
                <h2>Market Overview</h2>
                <p>Real-time market indices and futures will be displayed here.</p>
                <div id="marketOutput" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="alertsTab" class="tab-content">
            <div class="card">
                <h2>Alerts</h2>
                <p>Real-time profit alerts and market signals will appear here.</p>
                <div id="alertsOutput" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('chatTab', this)">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
        </button>
        <button class="tab-button" onclick="showTab('tickerTab', this)">
            <i class="fas fa-chart-line"></i>
            <span>Ticker</span>
        </button>
        <button class="tab-button" onclick="showTab('analysisTab', this)">
            <i class="fas fa-magnifying-glass-chart"></i>
            <span>Analysis</span>
        </button>
        <button class="tab-button" onclick="showTab('playsTab', this)">
            <i class="fas fa-play"></i>
            <span>Plays</span>
        </button>
        <button class="tab-button" onclick="showTab('marketTab', this)">
            <i class="fas fa-globe"></i>
            <span>Market</span>
        </button>
        <button class="tab-button" onclick="showTab('alertsTab', this)">
            <i class="fas fa-bell"></i>
            <span>Alerts</span>
        </button>
    </div>

    <script>
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const tickerInput = document.getElementById('tickerInput');

        // Array to store chat history for AI context
        const chatHistory = [{ type: 'assistant', content: "Hello! I'm Rolo, your AI-powered trading assistant. How can I help you today?" }];

        // Function to switch tabs
        function showTab(tabId, button) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(tabId).classList.add('active');
            // Activate the clicked button
            button.classList.add('active');
        }

        // Scroll chat window to bottom
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Display message in chat window and add to history
        function displayMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', type);
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('chat-message-bubble'); // Changed class to avoid conflict
            // Basic markdown-like formatting for bold
            bubbleDiv.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.appendChild(bubbleDiv);
            chatWindow.appendChild(messageDiv);
            chatHistory.push({ type, content }); // Add to history
            scrollToBottom();
        }

        // Send message to Rolo AI (UPDATED FOR GEMINI)
        async function sendMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            displayMessage('user', messageText); // Display user message
            chatInput.value = ''; // Clear input field

            // Add typing indicator
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.classList.add('chat-message', 'assistant', 'typing-indicator-container');
            typingIndicatorDiv.innerHTML = `
                <div class="chat-message-bubble typing-indicator">
                    <span></span><span></span><span></span>
                </div>`;
            chatWindow.appendChild(typingIndicatorDiv);
            scrollToBottom();

            try {
                // Call the enhanced-rolo-chat Netlify function for Gemini
                const response = await fetch('/.netlify/functions/enhanced-rolo-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: messageText,
                        history: chatHistory // Send the full history for context
                    }),
                });

                // Remove typing indicator
                chatWindow.removeChild(typingIndicatorDiv);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayMessage('assistant', data.response); // Display Rolo AI's response

            } catch (error) {
                console.error('Error sending message to Rolo AI:', error);
                // Remove typing indicator if error occurs during fetch
                const existingTypingIndicator = chatWindow.querySelector('.typing-indicator-container');
                if (existingTypingIndicator) {
                    chatWindow.removeChild(existingTypingIndicator);
                }
                displayMessage('assistant', `<span style="color: red;">Rolo AI is experiencing an issue: ${error.message}. Please try again later. Make sure your Gemini API key is configured in Netlify.</span>`);
            }
        }

        // Search Stock function (Ticker Tab) - (UPDATED FOR ALPHA VANTAGE)
        async function searchStock() {
            const symbol = tickerInput.value.toUpperCase().trim();
            const tickerOutput = document.getElementById('tickerOutput');

            if (!symbol) {
                tickerOutput.innerHTML = '<p style="color: #ff3b30;">Please enter a stock symbol (e.g., AAPL).</p>';
                return;
            }

            tickerOutput.innerHTML = `<p style="color: #0a84ff;">Fetching real-time data for ${symbol}...</p>`;

            try {
                // Call your stock-data.js Netlify Function
                const response = await fetch(`/.netlify/functions/stock-data?symbol=${symbol}`);
                const data = await response.json();

                if (!response.ok) {
                    // Handle errors from the Netlify Function
                    throw new Error(data.message || 'Failed to fetch stock data.');
                }

                // Display the real-time stock data
                tickerOutput.innerHTML = `
                    <div style="margin-top: 15px;">
                        <h3 style="color: #0a84ff;">${data.symbol} Live Data</h3>
                        <p><strong>Price:</strong> $${data.price}</p>
                        <p><strong>Change:</strong> <span style="color: ${data.change >= 0 ? '#34c759' : '#ff3b30'};">${data.change} (${data.changePercent})</span></p>
                        <p><strong>Volume:</strong> ${data.volume}</p>
                        <p><strong>High:</strong> $${data.high}</p>
                        <p><strong>Low:</strong> $${data.low}</p>
                        <p><strong>Open:</strong> $${data.open}</p>
                        <p><strong>Previous Close:</strong> $${data.previousClose}</p>
                        <p style="font-size: 12px; color: #8e8e93;">Last Updated: ${data.lastUpdated} (Source: ${data.source})</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching stock data:', error);
                tickerOutput.innerHTML = `<p style="color: #ff3b30;">Error: ${error.message || 'Could not retrieve stock data.'} Please try again.</p>`;
            }
        }

        // Placeholder for other tab functions (will be implemented in next steps)
        function loadMarketDashboard() {
            document.getElementById('marketOutput').innerHTML = '<p style="color: #0a84ff;">Loading market data... (Will connect to Alpha Vantage)</p>';
            // Actual fetch call for market-dashboard.js will go here
        }

        function loadSmartPlays() {
            document.getElementById('playsOutput').innerHTML = '<p style="color: #0a84ff;">Generating smart plays... (Will connect to smart-plays-generator.js)</p>';
            // Actual fetch call for smart-plays-generator.js will go here
        }

        function loadSmartAlerts() {
            document.getElementById('alertsOutput').innerHTML = '<p style="color: #0a84ff;">Checking for alerts... (Will connect to realtime-alerts.js)</p>';
            // Actual fetch call for realtime-alerts.js will go here
        }

        function updateAnalysisTab(ticker, data) {
            const analysisOutput = document.getElementById('analysisOutput');
            analysisOutput.innerHTML = `<p style="color: #0a84ff;">Analyzing ${ticker}... (Will provide detailed analysis)</p>`;
            // This function will be enhanced later to display more detailed analysis
        }


        // Event listeners for input fields
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        tickerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        // Auto-uppercase ticker input
        tickerInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });


        // Automatically load the chat tab on page load
        document.addEventListener('DOMContentLoaded', () => {
            showTab('chatTab', document.querySelector('.tab-button.active'));
            // Initial call to load some data for other tabs if desired, or load on tab switch
            // For now, they will show their "Loading..." message when clicked.
        });
    </script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>
